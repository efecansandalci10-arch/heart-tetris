<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const COLS = 10;
const ROWS = 20;
let SIZE = Math.floor(window.innerWidth / 12);

canvas.width = COLS * SIZE;
canvas.height = ROWS * SIZE;

let board = Array.from({length:ROWS},()=>Array(COLS).fill(0));
let score = 0;

const shapes = [
  [[1,1,1,1]],                    // I
  [[1,1],[1,1]],                  // O
  [[0,1,0],[1,1,1]],              // T
  [[1,0,0],[1,1,1]],              // L
  [[0,0,1],[1,1,1]],              // J
  [[0,1,1],[1,1,0]],              // S
  [[1,1,0],[0,1,1]]               // Z
];

let lastShapeIndex = -1;

function randomShape(){
  let index;
  do {
    index = Math.floor(Math.random()*shapes.length);
  } while(index === lastShapeIndex); // aynÄ± ÅŸekil art arda gelmez

  lastShapeIndex = index;

  let shape = JSON.parse(JSON.stringify(shapes[index]));

  // Rastgele rotate edilmiÅŸ spawn
  let rotations = Math.floor(Math.random()*4);
  for(let i=0;i<rotations;i++){
    shape = rotateMatrix(shape);
  }

  return shape;
}

function rotateMatrix(matrix){
  return matrix[0].map((_,i)=>
    matrix.map(row=>row[i]).reverse()
  );
}

function createPiece(){
  const shape = randomShape();
  return {
    shape: shape,
    x: Math.floor((COLS - shape[0].length)/2),
    y: 0
  };
}

let piece = createPiece();

function drawCell(x,y){
  ctx.fillStyle="#ff4e8a";
  ctx.shadowColor="#ff2e88";
  ctx.shadowBlur=8;
  ctx.font = (SIZE-6)+"px Arial";
  ctx.textAlign="center";
  ctx.fillText("ðŸ’–",x*SIZE+SIZE/2,y*SIZE+SIZE/1.2);
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(board[r][c]) drawCell(c,r);
    }
  }

  piece.shape.forEach((row,r)=>{
    row.forEach((val,c)=>{
      if(val) drawCell(piece.x+c,piece.y+r);
    });
  });
}

function collide(){
  for(let r=0;r<piece.shape.length;r++){
    for(let c=0;c<piece.shape[r].length;c++){
      if(piece.shape[r][c]){
        let newX = piece.x + c;
        let newY = piece.y + r;
        if(newX<0||newX>=COLS||newY>=ROWS||board[newY]?.[newX]){
          return true;
        }
      }
    }
  }
  return false;
}

function merge(){
  piece.shape.forEach((row,r)=>{
    row.forEach((val,c)=>{
      if(val){
        board[piece.y+r][piece.x+c]=1;
      }
    });
  });
}

function clearLines(){
  let lines = 0;
  board = board.filter(row=>{
    if(row.every(cell=>cell)){
      lines++;
      return false;
    }
    return true;
  });

  while(board.length<ROWS){
    board.unshift(Array(COLS).fill(0));
  }

  if(lines){
    score += lines*10;
    document.getElementById("score").innerText="Score: "+score;
  }
}

function newPiece(){
  piece = createPiece();
  if(collide()){
    alert("ðŸ’” Game Over ðŸ’”");
    board = Array.from({length:ROWS},()=>Array(COLS).fill(0));
    score=0;
    document.getElementById("score").innerText="Score: 0";
  }
}

function move(dir){
  piece.x+=dir;
  if(collide()) piece.x-=dir;
  draw();
}

function rotate(){
  const old = piece.shape;
  piece.shape = rotateMatrix(piece.shape);
  if(collide()) piece.shape = old;
  draw();
}

function drop(){
  piece.y++;
  if(collide()){
    piece.y--;
    merge();
    clearLines();
    newPiece();
  }
  draw();
}

function update(){
  drop();
}

setInterval(update,600);
draw();
</script>
